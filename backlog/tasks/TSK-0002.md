# Task Specification: TSK-0002

## Document Control
| Version | Date | Author | Reviewer | Notes |
|---------|------|--------|----------|-------|
| 1.0     | 2025-11-21 | Engineering Team | Data Lead | Ready for Implementation |

## Approvals
| Name | Role | Signature | Date |
|------|------|-----------|------|
| TBD | Data Lead | | |
| TBD | Solution Architect | | |

## 1. Metadata
| Field | Value |
|-------|-------|
| Task ID | TSK-0002 |
| Task Title | Design and Implement SQL Database Schema for Document Metadata |
| Parent Story | US-0001 - L&D Admin Document Upload |
| Feature | FE-0001 - Content Ingestion & Management |
| Epic | EP-0001 - AI-Powered Learning & Training Platform |
| Assigned To | Data Lead |
| Sprint | Sprint 1 |
| Story Points | 5 |
| Priority | Critical |
| Status | To Do |
| Dependencies | None (foundational task) |

## 2. Objective
Design and implement the SQL Database schema for storing document metadata (title, description, source, file type, size, blob URL, status) to support content ingestion and repository management.

## 3. Prerequisites
- [x] Azure SQL Database provisioned (`sqldb-edutrack-dev`)
- [ ] Database connection string stored in Azure Key Vault
- [ ] Entity Framework Core CLI tools installed
- [ ] Access permissions granted (database contributor role)

## 4. Detailed Description

**Database Tables to Create:**

1. **Documents Table** (`dbo.Documents`)
   - `DocumentId` (uniqueidentifier, PK) - UUID for document
   - `Title` (nvarchar(500), NOT NULL) - Document title (auto-populated from filename)
   - `Description` (nvarchar(MAX), NULL) - Optional user description
   - `SourceType` (nvarchar(50), NOT NULL) - e.g., "LocalUpload", "SharePoint", "Confluence"
   - `SourceUrl` (nvarchar(2000), NULL) - Original source URL (if applicable)
   - `SourceAuthor` (nvarchar(255), NULL) - Original author
   - `FileType` (nvarchar(20), NOT NULL) - PDF, DOCX, PPTX, MD, HTML
   - `FileSizeBytes` (bigint, NOT NULL) - File size in bytes
   - `FileHash` (nvarchar(64), UNIQUE, NOT NULL) - SHA-256 hash for deduplication
   - `BlobUrl` (nvarchar(2000), NOT NULL) - Azure Blob Storage URL
   - `IngestionDate` (datetime2, NOT NULL, DEFAULT GETUTCDATE()) - Ingestion timestamp
   - `Status` (nvarchar(50), NOT NULL, DEFAULT 'Ingested') - Ingested, Processing, Failed, Archived
   - `Version` (int, NOT NULL, DEFAULT 1) - Version number
   - `CreatedBy` (nvarchar(255), NOT NULL) - User who uploaded (Azure AD user ID)
   - `CreatedAt` (datetime2, NOT NULL, DEFAULT GETUTCDATE())
   - `UpdatedBy` (nvarchar(255), NULL)
   - `UpdatedAt` (datetime2, NULL)
   - `IsDeleted` (bit, NOT NULL, DEFAULT 0) - Soft delete flag
   - `DeletedAt` (datetime2, NULL)

2. **DocumentTags Table** (`dbo.DocumentTags`) - Many-to-many relationship
   - `DocumentTagId` (int, PK, IDENTITY)
   - `DocumentId` (uniqueidentifier, FK to Documents)
   - `Tag` (nvarchar(100), NOT NULL)
   - `CreatedAt` (datetime2, NOT NULL, DEFAULT GETUTCDATE())

3. **Indexes:**
   - Clustered index on `DocumentId` (PK)
   - Unique index on `FileHash` (for fast duplicate detection)
   - Non-clustered index on `SourceType, IngestionDate` (for filtering)
   - Non-clustered index on `Status` (for status queries)
   - Full-text index on `Title, Description` (for search)

**Implementation Approach:**
- Use Entity Framework Core Code-First migrations
- Create C# entity models matching schema
- Generate migration scripts with `dotnet ef migrations add InitialDocumentSchema`
- Apply migration with `dotnet ef database update`
- Seed initial test data (5-10 sample documents)

**Design References:**
- Data Architecture: Section 3.2 (Content Domain - Document entity)
- SRS: SRS-FUNC-009 (Document metadata storage)
- NFR: NFR-PERF-TH-006 (1M document storage capacity)

## 5. Acceptance Criteria

| AC ID | Scenario | Given | When | Then | Verification Evidence |
|-------|----------|-------|------|------|----------------------|
| AC-TSK0002-001 | Schema created | Azure SQL Database is provisioned | Data Lead applies EF migration | `Documents` and `DocumentTags` tables exist with correct columns and constraints | SQL query: `SELECT * FROM INFORMATION_SCHEMA.TABLES` |
| AC-TSK0002-002 | Unique constraint on FileHash | Schema is deployed | Two documents with same hash are inserted | Second insert fails with unique constraint violation | Test script demonstrating constraint enforcement |
| AC-TSK0002-003 | Indexes created | Schema is deployed | Query performance tested | Queries on `FileHash` and `Status` execute in <10ms for 1000 rows | Query execution plan analysis |
| AC-TSK0002-004 | Seed data inserted | Migration is complete | Seed data script executed | 10 test documents visible in database | SQL query: `SELECT COUNT(*) FROM Documents` returns 10 |
| AC-TSK0002-005 | EF model validated | Entity classes created | Unit tests run | Entity models correctly map to database schema; navigation properties work | Unit test results: all green |

## 6. Definition of Done (DoD) Checklist

### Code/Database
- [ ] C# entity models created (`Document.cs`, `DocumentTag.cs`) in `Domain/Entities` folder
- [ ] DbContext class created (`ApplicationDbContext.cs`) with DbSets
- [ ] EF Core migration script generated (`Migrations/YYYYMMDDHHmmss_InitialDocumentSchema.cs`)
- [ ] Migration applied to dev database successfully
- [ ] Indexes created (FileHash unique, Status, SourceType+IngestionDate)
- [ ] Full-text index on Title+Description configured
- [ ] Seed data script created and executed (`Data/SeedDocuments.sql`)
- [ ] Database connection string retrieved from Key Vault (no hardcoded credentials)

### Testing
- [ ] Unit tests for entity models (validation rules) - PASS
- [ ] Integration test: Insert document → retrieve by FileHash - PASS
- [ ] Integration test: Duplicate FileHash insert → constraint violation - PASS
- [ ] Integration test: Query performance on 1000 rows (<10ms) - PASS
- [ ] Database schema validation against Data Architecture - MATCH

### Documentation
- [ ] Entity Relationship Diagram (ERD) created (`docs/design/erd-documents.png`)
- [ ] Migration script documented with inline comments
- [ ] README updated with database setup instructions
- [ ] Data dictionary added to wiki (column descriptions, constraints)

### Security & Compliance
- [ ] Column-level encryption for sensitive fields (if any) - N/A (no PII in this table)
- [ ] RBAC validated (app service can read/write, developers read-only)
- [ ] Audit logging configured for schema changes
- [ ] Soft delete implemented (IsDeleted flag) for GDPR compliance

### Approvals & Sign-off
- [ ] Code review completed (2+ reviewers)
- [ ] Data Lead approval
- [ ] Solution Architect approval (schema design validation)
- [ ] Task marked as "Done" in Azure DevOps

## 7. Dependencies

### Blocking Dependencies
- DEP-TSK0002-001: Azure SQL Database provisioned - **Status:** ✅ Complete

### Downstream Dependencies
- TSK-0005: Implement backend API (requires Document entity model)
- TSK-0006: Implement duplicate detection (requires FileHash unique index)

## 8. Risks & Mitigations

| Risk ID | Description | Impact | Probability | Mitigation | Owner |
|---------|-------------|--------|-------------|------------|-------|
| RISK-TSK0002-001 | EF migration conflicts with existing schema | High | Low | Fresh database in dev; no existing schema | Data Lead |
| RISK-TSK0002-002 | Performance issues with full-text index on large datasets | Medium | Medium | Monitor query performance; optimize index configuration if needed | Data Lead |
| RISK-TSK0002-003 | Unique constraint on FileHash blocks legitimate duplicates (different versions) | Medium | Low | Version field tracks versions; hash changes when content changes | Solution Architect |

## 9. Traceability

### Requirements Traceability
| Requirement Type | ID | Description | How Addressed |
|------------------|--------|-------------|---------------|
| BRD | BRD-FR-006 | Content repository with metadata | Implements metadata storage |
| SRS | SRS-FUNC-009 | Store document metadata | Direct implementation |
| SRS | SRS-FUNC-007 | Deduplicate documents based on SHA-256 hash | FileHash unique constraint |
| NFR | NFR-PERF-TH-006 | Support 1M documents | Database design supports scalability |

### Design Traceability
- Data Architecture: Section 3.2 (Content Domain - Document entity)
- Threat Model: TAMP-002 (Training record modification - mitigated by audit logging)

## 10. Implementation Guidance

### Entity Model Example (C#)
```csharp
public class Document
{
    public Guid DocumentId { get; set; }
    public string Title { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string SourceType { get; set; } = string.Empty;
    public string? SourceUrl { get; set; }
    public string? SourceAuthor { get; set; }
    public string FileType { get; set; } = string.Empty;
    public long FileSizeBytes { get; set; }
    public string FileHash { get; set; } = string.Empty;
    public string BlobUrl { get; set; } = string.Empty;
    public DateTime IngestionDate { get; set; } = DateTime.UtcNow;
    public string Status { get; set; } = "Ingested";
    public int Version { get; set; } = 1;
    public string CreatedBy { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public string? UpdatedBy { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public bool IsDeleted { get; set; } = false;
    public DateTime? DeletedAt { get; set; }
    
    public ICollection<DocumentTag> Tags { get; set; } = new List<DocumentTag>();
}
```

### Migration Commands
```bash
# Create migration
dotnet ef migrations add InitialDocumentSchema

# Apply migration to dev database
dotnet ef database update --connection "Server=tcp:sql-edutrack-dev.database.windows.net,1433;Database=sqldb-edutrack-dev;..."

# Rollback migration (if needed)
dotnet ef database update PreviousMigrationName
```

### Estimated Effort
- **Development:** 3 hours (entity models, migration script)
- **Testing:** 1.5 hours (unit tests, integration tests)
- **Documentation:** 0.5 hours (ERD, wiki update)
- **Total:** 5 hours (0.625 developer days) = **5 story points**

## 11. Validation Evidence

### Evidence Required
1. Screenshot: Azure Data Studio showing table schema
2. ERD diagram: `docs/design/erd-documents.png`
3. Test results: Unit test + integration test execution log
4. Code review: Pull request approved

### Evidence Storage
- Screenshots: `docs/evidence/sprint-1/TSK-0002/`
- Logs: Attached to Azure DevOps work item

## 12. Change Log
| Change ID | Date | Section | Summary | Author |
|-----------|------|---------|---------|--------|
| TSK-CH-002 | 2025-11-21 | All | Initial task specification | Engineering Team |

## 13. Approvals
| Name | Role | Decision | Date | Notes |
|------|------|----------|------|-------|
| TBD | Data Lead | Pending | | Schema design validation required |
| TBD | Solution Architect | Pending | | Traceability to Data Architecture required |

---

**Task Status:** Ready for Implementation  
**Next Steps:** Assign to Data Lead for Sprint 1; await Azure SQL Database provisioning  
**Estimated Completion:** Sprint 1, Week 1 (Day 2-3)
